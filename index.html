<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tembea360 ‚Äî Explore Kajiado</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    *{box-sizing:border-box}
    body{font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f6f6f5;color:#222}
    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,#00897b 0%,#f57c00 100%);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 18px rgba(0,0,0,0.15)}
    .hero{background: linear-gradient(rgba(0,0,0,0.45), rgba(0,0,0,0.35)), url('https://images.unsplash.com/photo-1605727216801-e3fbb767cebd?auto=format&fit=crop&w=1400&q=60') center/cover no-repeat;color:#fff;text-align:center;padding:86px 18px;border-bottom:6px solid rgba(0,0,0,0.04)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:18px auto 6px}
    input[type="search"], select{padding:10px 12px;border-radius:8px;border:1px solid #d7d7d7;min-width:200px}
    .btn-primary{background:#f57c00;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr;gap:18px;padding:6px}
    @media(min-width:880px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:linear-gradient(180deg,#ffffff,#fff8e1);border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.08);transition:transform .28s ease,box-shadow .28s ease;padding-bottom:14px}
    .card-header{display:flex;gap:14px;align-items:center;padding:14px 16px}
    .thumb{width:96px;height:72px;border-radius:8px;object-fit:cover;border:1px solid #eee}
    .card-title{font-size:1.12rem;margin:0;color:#00695c;font-weight:700}
    .meta{font-size:0.9rem;color:#555;margin-top:6px}
    .card-body{padding:0 16px 12px}
    .desc{margin:8px 0 12px;color:#333}
    .sub {background:#fff;border-radius:8px;padding:10px 12px;margin-bottom:10px;border-left:4px solid #f57c00}
    .transport-row{display:flex;flex-direction:column;gap:8px}
    .transport-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:linear-gradient(90deg,#fff,#fffef0);border:1px solid #efe3cf}
    .transport-name{font-weight:700;color:#004d40}
    .transport-route{font-size:0.95rem;color:#555}
    .transport-fare{font-weight:700;color:#bf360c}
    .call-btn{background:#00695c;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:800}
    #map{height:420px;border-radius:12px;margin:20px auto;box-shadow:0 8px 18px rgba(0,0,0,0.12)}
    footer{padding:18px;text-align:center;background:linear-gradient(90deg,#004d40,#f57c00);color:#fff;margin-top:26px}
    .muted{color:#666;font-size:0.92rem}
    .loading{opacity:0.6;font-size:0.95rem}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:0">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:10px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.5 7H20l-5.5 4 2 7L12 16 7.5 20l2-7L4 9h4.5L12 2z" fill="#f57c00"/></svg>
        </div>
        <h1 style="margin:0;font-size:1.3rem">Tembea360</h1>
      </div>
      <nav style="padding-right:8px">
        <a href="#places" style="margin-right:12px;color:#fff;text-decoration:none;font-weight:600">Destinations</a>
        <a href="#map" style="margin-right:12px;color:#fff;text-decoration:none;font-weight:600">Map</a>
        <a href="#bookings" style="color:#fff;text-decoration:none;font-weight:600">Bookings</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h2 style="margin:0;font-size:2rem;letter-spacing:1px">Discover Kajiado</h2>
      <p style="margin-top:8px;color:#fffde7">See matatu routes, nearby lodgings and tours ‚Äî tap a call button to book.</p>
    </div>
  </section>

  <div class="container" id="places">
    <div class="controls">
      <input id="globalSearch" type="search" placeholder="Search destinations, lodges or SACCOs..." />
      <select id="filterType">
        <option value="all">All</option>
        <option value="nature">Nature</option>
        <option value="culture">Cultural</option>
        <option value="food">Food & Relaxation</option>
      </select>
      <button id="locateBtn" class="btn-primary">Show My Location</button>
      <div id="status" class="loading" style="display:none">Updating...</div>
    </div>

    <div class="grid" id="attractionGrid"></div>

    <div id="map" style="margin-top:18px"></div>

    <section id="bookings" style="margin-top:18px">
      <h2 style="text-align:center;color:#004d40">Book Stays & Tours</h2>
      <div id="lodgingGrid" class="grid" style="margin-top:12px"></div>
    </section>

    <section id="contact" style="margin-top:20px">
      <h2 style="text-align:center;color:#004d40">Contact & Quick Booking</h2>
      <div style="text-align:center;margin-top:10px" class="muted">Phone: +254 700 123 456 ¬∑ Email: bookings@tembea360.co.ke</div>
    </section>
  </div>

  <footer>¬© 2025 Tembea360 ¬∑ Explore Kajiado</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------- Config ---------- */
const DATA_URL = 'data/data.json';
const POLL_INTERVAL_MS = 12000; // auto-refresh interval

/* ---------- State ---------- */
let lastRaw = null;
let data = null;
let map = null;
let userMarker = null;
let markers = {};

/* ---------- Utilities ---------- */
function kmBetween(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return +(R * c).toFixed(1);
}
function toGMaps(at){ return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(at.lat + ',' + at.lon)}&travelmode=driving`; }

/* ---------- Fetch & render ---------- */
async function fetchData(showStatus = true){
  try{
    if(showStatus) document.getElementById('status').style.display='inline';
    const res = await fetch(DATA_URL + '?v=' + Date.now(), {cache: 'no-store'});
    if(!res.ok) throw new Error('Failed to load data.json');
    const raw = await res.text();
    if(raw === lastRaw){
      if(showStatus) document.getElementById('status').style.display='none';
      return; // no change
    }
    lastRaw = raw;
    data = JSON.parse(raw);
    renderAll();
  }catch(err){
    console.error('data load error',err);
  } finally {
    if(showStatus) document.getElementById('status').style.display='none';
  }
}

/* ---------- Render attractions & map & lodgings ---------- */
function initMap(){
  map = L.map('map').setView([-1.85,36.8],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
}

function clearMarkers(){
  Object.values(markers).forEach(m=>map.removeLayer(m));
  markers = {};
}

function renderAll(){
  if(!data) return;
  renderAttractions();
  renderLodgings();
  renderMarkers();
}

function renderAttractions(filterText = '', filterType = 'all'){
  const grid = document.getElementById('attractionGrid');
  grid.innerHTML = '';
  const f = (filterText||'').trim().toLowerCase();
  const list = data.attractions.filter(a=>{
    const okType = filterType==='all' || a.type===filterType;
    const okText = !f ||
      a.name.toLowerCase().includes(f) ||
      a.desc.toLowerCase().includes(f) ||
      (a.transport && a.transport.some(t=> t.sacco.toLowerCase().includes(f) || t.route.toLowerCase().includes(f)));
    return okType && okText;
  });
  list.forEach(at=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-header">
        <img class="thumb" src="${at.image||'https://source.unsplash.com/400x300/?'+encodeURIComponent(at.name)}" alt="${at.name}">
        <div style="flex:1">
          <div class="card-title">${at.name}</div>
          <div class="meta muted">${(at.type||'')}</div>
          <div class="muted" style="margin-top:6px">${(at.nearby && at.nearby.length)? 'Nearby: ' + at.nearby.join(', '): ''}</div>
        </div>
        <div class="actions">
          <a class="call-small" href="${toGMaps(at)}" target="_blank">Directions</a>
        </div>
      </div>
      <div class="card-body">
        <p class="desc">${at.desc}</p>

        <div class="sub">
          <h4>üöê Transport Options</h4>
          <div class="transport-row">
            ${ (at.transport||[]).map(t=>`
              <div class="transport-item">
                <div style="display:flex;flex-direction:column">
                  <div class="transport-name">${t.sacco}</div>
                  <div class="transport-route">${t.route}</div>
                </div>
                <div style="text-align:right">
                  <div class="transport-fare">${t.fare||''}</div>
                  <div style="margin-top:8px"><a class="call-btn" href="tel:${t.phone}">üìû Call to Book</a></div>
                </div>
              </div>
            `).join('') }
          </div>
        </div>

        <div class="sub">
          <h4>üè® Nearby Lodging</h4>
          <ul>${ (at.lodging||[]).map(l=>`<li>${l.name} ¬∑ <span class="muted">${l.time||''}</span></li>`).join('') }</ul>
        </div>

        <div class="sub">
          <h4>üéüÔ∏è Related Tours</h4>
          <ul>${ (at.tours||[]).map(t=>`<li>${t.name} ¬∑ <strong>${t.price||''}</strong></li>`).join('') }</ul>
        </div>

      </div>
    `;
    grid.appendChild(card);
  });
}

/* Lodgings list (bookings section) */
function renderLodgings(){
  const lg = document.getElementById('lodgingGrid');
  lg.innerHTML = '';
  (data.lodgings||[]).forEach(l => {
    const c = document.createElement('div'); c.className='card';
    c.innerHTML = `
      <div class="card-header">
        <img class="thumb" src="${l.image||'https://source.unsplash.com/400x300/?hotel'}" alt="${l.name}">
        <div>
          <div class="card-title">${l.name}</div>
          <div class="meta muted">${l.location || ''} ¬∑ ${l.phone||''}</div>
        </div>
      </div>
      <div class="card-body">
        <p class="desc">${l.location || ''}</p>
        <a href="${l.website||'#'}" target="_blank">${l.website? 'Visit website' : ''}</a>
      </div>
    `;
    lg.appendChild(c);
  });
}

/* Map markers */
function renderMarkers(){
  if(!map) initMap();
  clearMarkers();
  (data.attractions||[]).forEach(at=>{
    const m = L.marker([at.lat, at.lon]).addTo(map).bindPopup(`<b>${at.name}</b><br>${at.desc}`);
    markers[at.id] = m;
  });
}

/* ---------- Geolocation and distance updates ---------- */
function updateDistances(lat, lon){
  (data.attractions||[]).forEach(at=>{
    const el = document.getElementById(`dist-${at.id}`);
    // Note: in this render we didn't create separate distance placeholders; instead we update card meta text by re-rendering
    // Simplest: re-render attractions after updating distances so the UI shows distances inline if desired.
  });
}

function locateAndMark(){
  if(!navigator.geolocation){ alert("Geolocation not supported"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const userLat = pos.coords.latitude, userLon = pos.coords.longitude;
    if(userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([userLat,userLon]).addTo(map).bindPopup("You are here").openPopup();
    map.setView([userLat,userLon],10);

    // show distance in each card's meta area by adding distance text to meta
    data.attractions.forEach(at=>{
      const d = kmBetween(userLat,userLon,at.lat,at.lon);
      // find the card meta element by title and append distance
      const titles = document.getElementsByClassName('card-title');
      for(let t of titles){
        if(t.textContent.trim() === at.name){
          const meta = t.parentElement.querySelector('.meta');
          if(meta) meta.textContent = `${at.type || ''} ¬∑ ${d} km away`;
        }
      }
    });
  }, err=>{
    alert("Could not get your location. Please allow location access.");
  }, {enableHighAccuracy:true, timeout:10000});
}

/* ---------- Search & controls ---------- */
document.getElementById('globalSearch').addEventListener('input', e=>{
  renderAttractions(e.target.value, document.getElementById('filterType').value);
});
document.getElementById('filterType').addEventListener('change', ()=>{
  renderAttractions(document.getElementById('globalSearch').value, document.getElementById('filterType').value);
});
document.getElementById('locateBtn').addEventListener('click', locateAndMark);

/* ---------- Auto-refresh polling ---------- */
let pollTimer = null;
async function startPolling(){ 
  await fetchData(true); 
  pollTimer = setInterval(()=>fetchData(true), POLL_INTERVAL_MS);
}

/* ---------- Init ---------- */
function init(){
  initMap();
  fetchData(true);
  startPolling();
}
init();

</script>
</body>
</html>
